#!/usr/bin/env bash

# bash LAB-PLAYGROUND/exercises/run_vulnerability_scanning.sh 172.16.10.0/24

NETWORK_CIDR="$1"
COMMAND=$(basename "$0")

if [[ -z "$NETWORK_CIDR" ]]; then
  echo "Specify Network CIDR: $COMMAND <cidr>"
  exit 1
fi

echo "Analyzing $NETWORK_CIDR..."

# Scan FTP ports
RUSTSCAN_RESULTS=$( rustscan -a "$NETWORK_CIDR" -r 20-22 -b 1000 -g)

while read -r scan_result_line; do
  # 172.16.10.11 -> [21]
  ip_address=$(echo "$scan_result_line" | awk '{print $1}')
  ports=$(echo "$scan_result_line" | awk '{print $3}' | tr -d '[]' |  tr ',' ' ' | xargs)

  echo "IP Address: $ip_address. Ports to scan: $ports"

  for port in $ports; do
    # Run Nuclei scanning;
    NUCLEI_SCAN_RESULT=$(nuclei \
      -u "$ip_address:$port" \
      -tags "ftp" \
      -silent \
      -no-color
    )
    echo -e "\nNuclei Vulnerabilities Found for $ip_address:$port\n$NUCLEI_SCAN_RESULT"

    # Run Nmap scanning;
    NMAP_SCAN_RESULT=$(nmap --script="ftp-anon.nse" "$ip_address" -p "$port" | grep "| ")
    echo -e "\nNmap Vulnerabilities Found for $ip_address:$port\n$NMAP_SCAN_RESULT"
  done

done <<< "$RUSTSCAN_RESULTS"
